name: Staging Deploy

on:
  push:
    branches: [ honker, main ]

permissions:
  contents: read
  packages: write

jobs:
  # Detect which apps have changed
  detect-changes:
    runs-on: ubuntu-latest
    environment: CI
    outputs:
      controller: ${{ steps.filter.outputs.controller }}
      scraper: ${{ steps.filter.outputs.scraper }}
      textanalyzer: ${{ steps.filter.outputs.textanalyzer }}
      scheduler: ${{ steps.filter.outputs.scheduler }}
      web: ${{ steps.filter.outputs.web }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            controller:
              - 'apps/controller/**'
            scraper:
              - 'apps/scraper/**'
            textanalyzer:
              - 'apps/textanalyzer/**'
            scheduler:
              - 'apps/scheduler/**'
            web:
              - 'apps/web/**'

  # Test Go controller app
  test-controller:
    needs: detect-changes
    environment: CI
    if: needs.detect-changes.outputs.controller == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/controller
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'
          cache-dependency-path: apps/controller/go.sum

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: make test

  # Test Go scraper app
  test-scraper:
    needs: detect-changes
    environment: CI
    if: needs.detect-changes.outputs.scraper == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/scraper
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'
          cache-dependency-path: apps/scraper/go.sum

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: make test

  # Test Go textanalyzer app
  test-textanalyzer:
    needs: detect-changes
    environment: CI
    if: needs.detect-changes.outputs.textanalyzer == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/textanalyzer
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'
          cache-dependency-path: apps/textanalyzer/go.sum

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: make test

  # Test Go scheduler app
  test-scheduler:
    needs: detect-changes
    environment: CI
    if: needs.detect-changes.outputs.scheduler == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/scheduler
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.9'
          cache-dependency-path: apps/scheduler/go.sum

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        run: make test

  # Test JavaScript/React web app
  test-web:
    needs: detect-changes
    environment: CI
    if: needs.detect-changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  # Build and push staging images after tests pass
  build-and-push:
    runs-on: ubuntu-latest
    environment: CI
    needs: [test-controller, test-scraper, test-textanalyzer, test-scheduler, test-web]
    if: always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled')
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push all staging images
        run: |
          chmod +x build-staging.sh
          ./build-staging.sh push
        env:
          REGISTRY: ghcr.io/${{ github.repository_owner }}

  # Summary job
  staging-deploy-success:
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.build-and-push.result }}" == "failure" ]; then
            echo "Staging deployment failed"
            exit 1
          fi
          if [ "${{ needs.build-and-push.result }}" == "cancelled" ]; then
            echo "Staging deployment was cancelled"
            exit 1
          fi
          echo "âœ… Staging images built and pushed successfully!"
          echo "Images are available at: ghcr.io/${{ github.repository_owner }}/docutag-*:staging"
