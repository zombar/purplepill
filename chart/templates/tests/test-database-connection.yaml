{{- if .Values.postgresql.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "docutag.fullname" . }}-test-database
  labels:
    {{- include "docutag.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: postgres:15-alpine
    env:
      - name: PGHOST
        value: {{ include "docutag.postgresqlHost" . }}
      - name: PGPORT
        value: {{ include "docutag.postgresqlPort" . | quote }}
      - name: PGDATABASE
        value: {{ include "docutag.postgresqlDatabase" . }}
      - name: PGUSER
        value: {{ include "docutag.postgresqlUsername" . }}
      - name: PGPASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ include "docutag.postgresqlSecretName" . }}
            key: password
    command:
      - sh
      - -c
      - |
        set -e
        echo "Testing PostgreSQL database connection..."

        # Wait for database to be ready
        sleep 10

        # Test connection
        if psql -c "SELECT 1;" > /dev/null 2>&1; then
          echo "✓ Database connection successful"
          echo "  Host: $PGHOST:$PGPORT"
          echo "  Database: $PGDATABASE"
          echo "  User: $PGUSER"
          exit 0
        else
          echo "✗ Database connection failed"
          exit 1
        fi
{{- end }}
