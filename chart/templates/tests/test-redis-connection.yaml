{{- if .Values.redis.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "docutag.fullname" . }}-test-redis
  labels:
    {{- include "docutag.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: redis:7-alpine
    command:
      - sh
      - -c
      - |
        set -e
        echo "Testing Redis connection..."

        REDIS_ADDR="{{ include "docutag.redisAddr" . }}"
        echo "  Connecting to: $REDIS_ADDR"

        # Wait for Redis to be ready
        sleep 5

        # Test connection with PING
        if redis-cli -h ${REDIS_ADDR%:*} -p ${REDIS_ADDR#*:} PING | grep -q "PONG"; then
          echo "✓ Redis connection successful"
          exit 0
        else
          echo "✗ Redis connection failed"
          exit 1
        fi
{{- end }}
